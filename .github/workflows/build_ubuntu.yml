name: C/C++ CI

on:
  push:
    branches: [ "main", "tim_h" ]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - ".github/**"
  pull_request:
    branches: [ "main", "tim_h" ]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - ".github/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      CC: ccache clang
      CXX: ccache clang++
      DISPLAY: :99
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache cppcheck \
            libgtk-3-dev libsqlite3-dev libcurl4-openssl-dev \
            xvfb
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('**/*.c', '**/*.h', 'Makefile', '**/Makefile') }}
          restore-keys: |
            ccache-${{ runner.os }}-
      - name: Verify pkg-config packages
        run: |
          pkg-config --exists gtk+-3.0 libcurl
          echo "gtk+-3.0 and libcurl are available via pkg-config"
      - name: Build
        run: make -j"$(nproc)" sekai
      - name: Cppcheck
        run: |
          cppcheck --enable=warning,style,performance,portability \
                   --inline-suppr --suppress=missingIncludeSystem \
                   --error-exitcode=1 .
      - name: Start Xvfb
        run: Xvfb :99 -screen 0 1024x768x16 &
      - name: Build tests
        run: |
          make -C test -j"$(nproc)" clean
          make -C test -j"$(nproc)"
      - name: Run tests (xvfb)
        run: xvfb-run -a make -C test run
      - name: UI smoke test (non-blocking)
        run: |
          timeout 15s xvfb-run -a ./sekai -at || echo "UI smoke test skipped/timed out"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sekai-ubuntu
          path: sekai

